---
title: "Prevalence of Lyme Disease in the US"
runtime: shiny
output: html_document
---

This R Markdown document is made interactive using Shiny. Unlike the more traditional workflow of creating static reports, you can now create documents that allow your readers to change the assumptions underlying your analysis and see the results immediately. 

To learn more, see [Interactive Documents](http://rmarkdown.rstudio.com/authoring_shiny.html).


```{r, echo=FALSE, message=FALSE, warning=FALSE}
#help
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(magrittr))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(rgdal))
suppressPackageStartupMessages(library(rvest))
suppressPackageStartupMessages(library(maps))
suppressPackageStartupMessages(library(ggmap))
suppressPackageStartupMessages(library(shiny))

# loading and tidying data 
lyme.disease.counts <- read.csv("lyme.disease.dataset.csv") %>%
  tbl_df %>%
  rename("1992-1996" = X1992.1996, "1997-2001" = X1997.2001, "2002-2006" = X2002.2006, "2007-2011" =  X2007.2011, CountyFIPS = CountyCode, StateFIPS = StateCode) %>%
  gather("year.range", "counts", 5:8) %>%
  filter(StateName != "Hawaii") %>%
  filter(StateName != "Alaska")

# adding zeros to CountyFIPS so that 3 digits in order to merge 
lyme.disease.counts$CountyFIPS <- sprintf("%03d", lyme.disease.counts$CountyFIPS)

# pasting StateFIPS and CountyFIPS to get full FIPS code 
lyme.disease.counts$FIPS <- paste(lyme.disease.counts$StateFIPS, lyme.disease.counts$CountyFIPS, sep = "")

# turning NAs into zeros
lyme.disease.counts[is.na(lyme.disease.counts)] <- 0

# filtering out counts from unknown counties to be later included in state map
unknown.county.counts <- filter(lyme.disease.counts, CountyFIPS == 000)

# only known counties with FIPS codes
lyme.disease.counts$CountyFIPS <- as.numeric(lyme.disease.counts$CountyFIPS)
lyme.disease.counties <- filter(lyme.disease.counts, CountyFIPS != 000)

# Census 2010 
census2010 <- read.csv("Census2010StateCounty.csv") %>%
  tbl_df %>%
  rename("FIPS" = Geo_FIPS, "pop.density" = SE_T002_002, "tot.pop" = SE_T001_001) %>%
  mutate(pop.under.eighteen = SE_T008_002 + SE_T008_003 + SE_T008_004 + SE_T008_005) %>%
  mutate(per.pop.under.eighteen = ((pop.under.eighteen/tot.pop) * 100)) %>%
  select(FIPS, pop.density, per.pop.under.eighteen, tot.pop)

# converting to character to match types for join
census2010$FIPS <- as.character(census2010$FIPS)

# lyme state counts joined with census
lyme.counts.census <- inner_join(lyme.disease.counts, census2010, by = "FIPS") %>%
  mutate(prevalence = (counts/tot.pop) *100) %>%
  select(-CountyName, -StateFIPS, -CountyFIPS)

# totaling state counts and state population to calculate state prevalence 
lyme.state.prevalence <- group_by(lyme.counts.census, StateName, year.range) %>%
  summarise(tot.counts = sum(counts), tot.state.pop = sum(tot.pop)) %>%
  mutate(prevalence = (tot.counts/tot.state.pop)* 100)

# since montana has zero cases changed it to arizona which has the lowest prevalence of (1.564451e-05)
lyme.state.prevalence$prevalence <- replace(lyme.state.prevalence$prevalence, lyme.state.prevalence$prevalence == 0.000000e+00, 1.564451e-05)

# State map of US in 2010 
US.state <- map_data("state") %>% 
  tbl_df()

# clean text function
clean.text <- function(text){
  text <- gsub("[^[:alnum:]]", "", text)
  text <- gsub(" ", "", text)
  text <- tolower(text)
  return(text)
}

# cleaning up state names
lyme.state.prevalence$StateName <- clean.text(lyme.state.prevalence$StateName)
US.state$region <- clean.text(US.state$region)


# inner join with state geographic data
lyme.counts.states.geo <- inner_join(lyme.state.prevalence, US.state, by = c("StateName" = "region")) %>%
  select(-order, -subregion) 

inputPanel(
    selectInput("years", label = "Year",
              choices = c("1992-1996", "1997-2001", "2002-2006", "2007-2011"))
              )
renderPlot({
  year.choices <- input$years 
  lyme.counts.states.geo <- filter(lyme.counts.states.geo, year.range==year.choices)
  
 ggplot(lyme.counts.states.geo, aes(x=long, y=lat, group=group, fill = log10(prevalence))) +
  geom_polygon() +
  geom_path(col="black", size=0.05) +
  coord_map() +
  scale_fill_continuous(low="white", high="lawngreen", name="Prevalence") 
})


```




